{"version":3,"file":"offer-detail.js","sourceRoot":"","sources":["../../../src/assemble/assemble/offer-detail.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement, html } from 'lit';\nimport { state, customElement, property } from 'lit/decorators.js';\nimport { InstalledCell, AppWebsocket, Record, ActionHash, InstalledAppInfo, RecordEntry } from '@holochain/client';\nimport { contextProvided } from '@lit-labs/context';\nimport { decode } from '@msgpack/msgpack';\nimport { appInfoContext, appWebsocketContext } from '../../contexts';\nimport { Offer, Slot } from './offer';\nimport '@material/mwc-circular-progress';\nimport { EntryRecord, RecordBag } from '@holochain-open-dev/utils';\nimport { Commitment } from './commitment';\n\n@customElement('offer-detail')\nexport class OfferDetail extends LitElement {\n  @property()\n  actionHash!: ActionHash;\n\n  @state()\n  _offer: EntryRecord<Offer> | undefined;\n\n  @state()\n  _commitments: RecordBag<Commitment> | undefined;\n\n  @contextProvided({ context: appWebsocketContext })\n  appWebsocket!: AppWebsocket;\n\n  @contextProvided({ context: appInfoContext })\n  appInfo!: InstalledAppInfo;\n\n  async firstUpdated() {\n    const cellData = this.appInfo.cell_data.find((c: InstalledCell) => c.role_id === 'assemble')!;\n    const record: Record | undefined = await this.appWebsocket.callZome({\n      cap_secret: null,\n      cell_id: cellData.cell_id,\n      zome_name: 'assemble',\n      fn_name: 'get_offer',\n      payload: this.actionHash,\n      provenance: cellData.cell_id[1]\n    });\n\n   const commitments: Record[] = await this.appWebsocket.callZome({\n      cap_secret: null,\n      cell_id: cellData.cell_id,\n      zome_name: 'assemble',\n      fn_name: 'get_commitments_for',\n      payload: this.actionHash,\n      provenance: cellData.cell_id[1]\n    });\n    \n    this._commitments = new RecordBag(commitments);\n    \n    if (record) {\n      this._offer = new EntryRecord(record);\n    }\n  }\n  \n  cellData() {\n    return this.appInfo.cell_data.find((c: InstalledCell) => c.role_id === 'assemble')!;\n  }\n\n  async commitForSlot(index: number) {\n    const record: Record = await this.appWebsocket.callZome({\n      cap_secret: null,\n      cell_id: this.cellData().cell_id,\n      zome_name: 'assemble',\n      fn_name: 'create_commitment',\n      payload: {\n        offer_or_commitment_hash: this.actionHash,\n        fulfilling_slot_index: index,\n        slots: []\n      },\n      provenance: this.cellData().cell_id[1]\n    });\n    \n    try {\n    const promise: Record = await this.appWebsocket.callZome({\n      cap_secret: null,\n      cell_id: this.cellData().cell_id,\n      zome_name: 'assemble',\n      fn_name: 'create_promise',\n      payload: this.actionHash,\n      provenance: this.cellData().cell_id[1]\n    });\n      this.dispatchEvent(new CustomEvent('offer-completed', {\n        bubbles: true,\n        composed: true,\n        detail: {\n          promiseActionHash: promise.signed_action.hashed.hash\n        }\n      }))\n      } catch (e) {\n      \n    }\n    this._commitments?.add([record]);\n    this.requestUpdate();  \n  }\n  \n  renderSlotAction(s: Slot, index: number) {\n    const amIAuthor = this._offer?.action.author.toString() === this.cellData().cell_id[1].toString();\n    const isCompleted = !!this._commitments?.entryMap.values().find(c => c.fulfilling_slot_index === index);\n\n    if (isCompleted) return html`<mwc-icon>verified</mwc-icon>`;\n    if (amIAuthor) return html`<span>Pending</span>`;\n    return html`<mwc-button label=\"Commit\" @click=${()=> this.commitForSlot(index)}></mwc-button>`;    \n  }\n  \n  renderSlot(s: Slot, index: number) {\n    \n    return html`\n      <div style=\"display: flex; flex-direction: row\">\n      <div style=\"display: flex; flex-direction:column\">\n        <span><strong>${s.title}</strong></span>\n        <span>${s.description}</span>\n      </div>\n      \n      ${this.renderSlotAction(s, index)}\n      </div>\n      `;\n  }\n\n  render() {\n    if (!this._offer) {\n      return html`<div style=\"display: flex; flex: 1; align-items: center; justify-content: center\">\n        <mwc-circular-progress indeterminate></mwc-circular-progress>\n      </div>`;\n    }\n    return html`\n      <div style=\"display: flex; flex-direction: column; text-align: left\">\n        <span style=\"font-size: 18px\">Offer</span>\n\t\t  <div style=\"display: flex; flex-direction: column\">\n\t\t    <span><strong>Title</strong></span>\n\t\t    <span style=\"white-space: pre-line\">${ this._offer.entry.title }</span>\n\t\t  </div>\n\t\t  <div style=\"display: flex; flex-direction: column\">\n\t\t    <span><strong>Description</strong></span>\n\t\t    <span style=\"white-space: pre-line\">${this._offer.entry.description }</span>\n\t\t  </div>\n      <span style=\"margin-top: 16px\">Slots</span>\n      \n      ${this._offer.entry.slots.map((r, i) => this.renderSlot(r, i))}\n      \n      </div>\n    `;\n  }\n}\n"]}